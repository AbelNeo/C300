<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Player Profile | FootMaster Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/styles.css">

  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
  </script>
  <script type="module" src="js/firebase.js"></script>
  <script type="module" src="js/main.js"></script>
  <script type="module" src="components/navbar-component.js"></script>
  <script type="module" src="components/footer-component.js"></script>  
  <script type="module" src="uploadPlayerPhoto.js"></script>
</head>
<body>
  <header>
    <navbar-component></navbar-component>
  </header>
  <main class="container">
    <div class="player-profile" id="profile">
      <div class="loading">Loading player...</div>
    </div>
  </main>
  <script type="module">
    import { db, auth } from './js/firebase.js';
    import { doc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Get playerId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const playerId = urlParams.get('id');
    const profileDiv = document.getElementById('profile');
    let currentUserUid = null;

    function playerCardHTML(player, isFavorite, loggedIn) {
      return `
        <section class="players-section" style="margin-bottom: 1.5em; display: flex; align-items: flex-start;">
          <div style="margin-right: 24px; display: flex; align-items: center;">
            <img
              id="favoriteStar"
              alt="Favorite Player"
              width="32"
              height="32"
              src="${isFavorite ? 'https://images.onefootball.com/cw/icons/star-yellow-dark.svg' : 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/59/Yellow_bordered_white_star.svg/512px-Yellow_bordered_white_star.svg.png?20221001001156'}"
              class="star-favorite${isFavorite ? ' active' : ''}"
              style="color: transparent;${loggedIn ? '' : 'display:none;'}"
              title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}"
              >
            </div>
          <div class="player-card" style="max-width: 350px; margin: 0 auto;">
              <img src="${player.photoPath || player.photoURL ||  'https://via.placeholder.com/150x180?text=No+Photo'}" alt="${player.name}" class="player-portrait" style="height: 240px;">
              <div class="player-info">
                  <h3 class="player-name">${player.name}</h3>
                  <p class="player-position">${player.position || ''}</p>
                  <p class="player-team">${player.team || ''}</p>
              </div>
          </div>
        </section>
        <div class="divider"></div>
        ${player.teams ? `
        <section class="teams-grid" style="margin-bottom:1.5em;">
            <h2 style="color:#800000; margin-bottom:16px;">Teams</h2>
            <div style="display:flex; gap:32px; flex-wrap:wrap;">
              ${player.teams.map(team => `
                <div class="player-card" style="width:160px;">
                  <img src="${team.logo || 'https://via.placeholder.com/80'}" alt="${team.name}" class="player-portrait" style="height: 80px;">
                  <div class="player-info">
                      <p class="player-team">${team.name}</p>
                  </div>
                </div>
              `).join('')}
            </div>
        </section>
        ` : ''}
        <section class="stats-container" style="background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.07); padding:24px; max-width:650px; margin:0 auto;">
          <p class="title" style="color:#800000; font-weight: 600;">KEY STATS</p>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:18px; margin-top:18px;">
            <div>
                <p style="font-size:1.4em; color:#800000; font-weight:600;">${player.age || '-'}</p>
                <p>Age</p>
            </div>
            <div>
                <p style="font-size:1.2em; color:#800000;">${player.position || ''}</p>
                <p>Position</p>
            </div>
            <div>
                <p style="font-size:1.2em;">${player.country || player.nationality || '-'}</p>
                <p>Country</p>
            </div>
            <div>
                <p>${player.height || '-'}</p>
                <p>Height</p>
            </div>
            <div>
                <p>${player.weight || '-'}</p>
                <p>Weight</p>
            </div>
            <div>
                <p>${player.jerseyNumber || '-'}</p>
                <p>Jersey Number</p>
            </div>
          </div>
        </section>
      `;
    }

    
    

    // 1. Load Firestore player data
    async function loadPlayer() {
      if (!playerId) {
        profileDiv.innerHTML = '<div class="error">No player specified.</div>';
        return;
      }
      profileDiv.innerHTML = '<div class="loading">Loading player...</div>';
      const playerRef = doc(db, "Players", playerId);
      const snap = await getDoc(playerRef);
      if (!snap.exists()) {
        profileDiv.innerHTML = '<div class="error">Player not found.</div>';
        return;
      }
      const player = snap.data();

      // 2. Wait for auth state and render favorite button
      onAuthStateChanged(auth, async (user) => {
        currentUserUid = user ? user.uid : null;
        let isFavorite = false;
        if (user) {
          const userDoc = await getDoc(doc(db, "Accounts", currentUserUid));
          const favs = userDoc.exists() ? (userDoc.data().favoritePlayers || []) : [];
          isFavorite = favs.includes(playerId);
        }
        profileDiv.innerHTML = playerCardHTML(player, isFavorite, !!user);

        // 3. Set up favorite button logic
        const star = document.getElementById('favoriteStar');
        if (star && user) {
          star.addEventListener('click', async () => {
            star.style.pointerEvents = 'none';
            const userRef = doc(db, "Accounts", currentUserUid);
            const userDoc = await getDoc(userRef);
            const favs = userDoc.exists() ? (userDoc.data().favoritePlayers || []) : [];
            try {
              if (favs.includes(playerId)) {
                await updateDoc(userRef, { favoritePlayers: arrayRemove(playerId) });
                star.classList.remove('active');
                star.src = 'https://images.onefootball.com/cw/icons/star-outline-dark.svg';
                star.title = 'Add to favorites';
              } else {
                if (favs.length >= 3) {
                  alert('You can only have up to 3 favorite players.');
                  return;
                }
                await updateDoc(userRef, { favoritePlayers: arrayUnion(playerId) });
                star.classList.add('active');
                star.src = 'https://images.onefootball.com/cw/icons/star-yellow-dark.svg';
                star.title = 'Remove from favorites';
              }
            } catch (e) {
              alert('Failed to update favorite: ' + e.message);
            } finally {
              star.style.pointerEvents = '';
            }
          });
        }
      });
    }

    loadPlayer();

    
  </script>
  <form id="itemForm">
    <label for="name">Item Name:</label>
    <input type="text" id="name" required />

    <label for="description">Item Description:</label>
    <textarea id="description" required></textarea>

    <label for="price">Price ($):</label>
    <input type="number" id="price" step="0.01" min="0" required />

    <label for="stock">Stock Quantity:</label>
    <input type="number" id="stock" min="0" required />

    <label for="image">Upload Images:</label>
    <input type="file" id="image" accept="image/*" multiple />

    <button type="submit">Add Item</button>
  </form>

    <table id="itemsTable" style="display: none;">
    <thead>
      <tr>
        <th>Images</th>
        <th>Name</th>
        <th>Description</th>
        <th>Price ($)</th>
        <th>Stock</th>
        <th>Buy</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</body>
<footer-component></footer-component>
</html>